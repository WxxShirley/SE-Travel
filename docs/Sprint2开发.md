## Sprint2开发


### 总结一下遇到的坑
* js闭包中的`this`可能会和指代界面的全局`this`冲突，因此有的时候需要用其他变量指示`this`
```javascript
var that = this;

wx.cloud.downloadFile({
   fileID: '...', // 下载的文件名,
   success: res=>{
      that.setData({
      }) //注意此处用that
   }
})

```

* `wx.navigateTo`和`wx.redirectTo`比较
这两者都可以进行界面跳转,不同的是在界面形成的栈结构中，`wx.navigateTo`会将下一个要进入的界面入栈，界面深度是+1的，从新的界面返回会回到当前界面；
而`wx.redirectTo`界面会进行界面的重定向，会把当前界面从栈顶移出，将要进入的界面移入栈顶，因此如果从新界面返回，会回到原来的界面的上一级。
为了方式界面不停嵌套，而且微信小程序允许的界面栈深度为10. 有些时候使用`wx.redirectTo`非常必要。
> 目前在景区搜索功能里，界面都使用`navigaTo`来跳转，界面堆叠严重，后需要优化

* 同步和异步问题
有些地方可以通过`callback`函数强行同步。
或者设定较大的时间间隔调用`setTimeout`函数。
在`saveDiary`界面中，画布渲染后要将预览图上传到云端，但是非常诡异的是即使调用了`callback`函数也不能执行，🌚😈😈😈 
只能通过`setTimeOut`函数并且把时间调整为2s(这个延时效果非常差了....)才能正确执行


* 父子组件传值
在`diaryList`界面，是展示一个个用户已完成的手帐的缩略图界面，点击每个手帐的`setting menu`，会弹出是否删除或者保存图片的底部弹窗。如果选择了删除，会调用云函数删除指定的手帐。
但是这里是在`journal`组件里完成的，完成后这个组件需要告诉`diaryList`界面,也就是父子组件通信的问题，这样`diaryList`界面知道了有手帐被删除，重新发出加载的请求使得界面重新渲染，而不是用户手动下拉刷新。
在小程序里父子组件通信的方法：
```javascript
// 父组件的.wxml界面使用子组件时
<sonComponennt ... bindItemChange = "handleItemChange">

// 父组件的.js文件中编写handleItemChange函数，即处理子组件有变化时的逻辑函数
handleItemChange: function(e){
   console.log(e.detail) // 子组件传入的值
   // 执行相应的逻辑，比如在diaryList中就是重新请求加载所有的diary，调用this.setData({})使界面重新渲染
}

// 子组件中在合适的位置：
this.triggerEvent('itemChange', obj) // obj是要传递给父组件的内容

```

* 关于复用性
在我做的功能里，即用户编辑完手帐进入画布渲染、生成预览图上传、提供保存到本地的功能和在个人中心加载用户所有手帐功能中，为了快速实现功能，
各个云函数的实现已经放弃了复用，直接为删除手帐、加载手帐编写云函数。。🤦‍♀️
这个可能也是未来优化的目标，下次一定。。。

* 云函数操作小程序数据库的CRUD操作：
参考1[云函数操作数据库](https://zhuanlan.zhihu.com/p/120256279)
参考2[小程序文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-sdk-api/database/Database.html)


### 开发工程记录

| 任务                            | 完成时间      | 说明                                                         |
| ------------------------------- | -------- | ------------------------------------------------------------ |
| ~~【发布攻略】界面美化+API完成~~    | ~~1人11.14~~ | ~~界面增加padding,修改配色等,整体美观。用户点击发布攻略后将文字和图片都上传云端。另外，增加可选的tag。~~ |
| ~~接入腾讯地图~~                    | ~~1人11.14~~| ~~景区详细界面位置一栏点击进入腾讯地图界面，显示该景点和周围景点的marker，显示当前用户定位，接入导航。~~ |
| ~~【寻找驴友】界面+API完成~~        | ~~2人11.10~~ | ~~整个界面类似表单(一个文本段输入框，两个时间选择，一个单选性别，最后文本输入景点)~~                      |
| ~~【旅行手帐】界面完善~~          | ~~1人11.7~~ | ~~在"我的界面"按照发布时间逆序展示自己的旅行手帐，点击后进入静态界面，可以长按保存为图片~~ |
| ~~【瀑布流展示景点攻略】界面+接口~~ | ~~2人11.14~~ | ~~接口设计类似美团的分页策略，每次加载最新的20个，当用户滑动浏览完，可以继续加载（请求服务端）。瀑布流组件可参考目前已实现`waterfall`组件。~~ |


表格属性：
```javascript
// 景区攻略
var item = {
  "_id": "_fsrfrsf", // 云数据库自动生成的id
    
  "title": "攻略标题",
  "openid": "pofsefs2", // 云函数可以得到微信用户唯一的id，即openid
  "user_avatar": "用户微信头像url" , // app启动时获取用户信息的接口我已经加上了，在那里处理以下就行
  "nickname":"用户昵称",
  
  "timestamp":"2020/10/21 22:32:41", // 用户发布的时间戳，需要转成这样的时间格式
  "txt_content":"好多人啊", // 攻略文本内容
  "shortDescrip": txt_content.substr(0.20)+"...",
  "imgList": [
    "cloud://....", // 图片在云端的位置
  ],
  "imgSrc": "cloud://....", // 第一张图片在云端的位置
  "tags":[
    "清凉夏日","亲子游"
  ],
  "likes":0, // 点赞数目
}
// 提交要求：
//   至少选择1个tag，20个以上字符，1张图片
/*
    tag list: 
      古色古香  养生休闲 红色之旅
      游乐园 探险体验 民俗体验 感受名校 影视基地
      周末活动 深度人文 亲子游 清凉夏日 自然探索
      ````（一些热门的上海市景点） 
*/


// 寻找驴友
var item = {
  "_id": "_fsefe" ,// 云数据库自动生成的
  "openid": "fsrsfsrfa", // 云函数可以得到微信用户唯一的id，即openid
  "profile_url":"用户微信头像url",
  "nickname":"二C",
  
  "timestamp":"2020/10/21 22:32:41", // 用户发布的时间戳
  
  "content":"找一个小姐姐，元旦迪士尼约！",
  "demands":{
    "gender":"female",// ["female", "male","none"] 
    "valid_time": ["发布日期","旅行日期"], // 招募驴友贴的有效日期
    "bindAttraction": "迪士尼乐园"
  },
  "expired":false , //是否过期，后端定时执行扫描任务，查看寻找驴友贴是否过期
}
```

获得用户昵称和头像的办法
```javascript
const app=getApp(); //写在文件顶部

var nickname = app.globalData.userInfo.nickName;
var profile_url = app.globalData.userInfo.avatarUrl
```

前端要求：

* 组件 all-in-place,提供必要的加载或者提示，注意**同步**和**异步**
* 尽量美观
* 接入地图服务的markers中需要有周围景点，最好点击后进入相应的景点(方法以及封装在`utils.js`中).由于我们的数据库中只保存了每个景点周围景点的id，这些景点对应的经纬度需要查询。如果用for循环逐个查询太低效了，我想到的解决办法是开启多线程查询或者用空间换时间(新建一张表，对应景区id到周围景点信息List形式的）.
> 对于提交类(寻找驴友)的任务，为防止用户多次点击错误操作引起多次插入(并不幂等）, 计算用户两次点的时间差，如果<5s展示不要连续点击的toast


后端API：

* 实现无线加载的瀑布流中，请求的参数有页码或者上次扫描的最后一个的id（具体看云数据库支持的查询办法），返回参数有我们限制的规模大小的列表和布尔型变量`hasMore`（是否已经到达末尾）


> 前后端交互的逻辑可以参考`diary`中上传图片的策略，尤其是异步问题的解决


测试：
* 前端编写单元测试，[单元测试文档](https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/unit-test.html)
* 对于不便编写单元测试的功能，请说明**测试用例、期待结果和实际结果**

需要讨论：
* 驴友贴和攻略绑定某个景区是否必要，还是为了方便起见，仅加一个用户输入景区名称的文本框？
* 其他功能的实现
